{% extends "base.html" %}
{% block content %}
  <div class="header">
    {% if user_logged_in %}
      <p>Logged in as: <strong>{{ session.get('username') }}</strong></p>
      <a href="{{ url_for('logout') }}" class="logout-button">Logout</a>
      {% if session.get('is_admin') %}
        <a href="{{ url_for('admin') }}" class="admin-button">Go to Admin Panel</a>
      {% endif %}
    {% else %}
      <a href="{{ url_for('login') }}">Login</a> |
      <a href="{{ url_for('register') }}">Register</a>
    {% endif %}
  </div>

  <h2>Chat Room</h2>

  {% if error_message %}
    <p style="color: red;">{{ error_message }}</p>
  {% endif %}

  {% if user_logged_in %}
    <form method="GET" action="{{ url_for('chat') }}">
        <input type="text" name="search" placeholder="Search messages" value="{{ search_query or '' }}">
        <input type="submit" value="Search">
    </form>
  {% endif %}

  {% if user_logged_in %}
    <form method="POST">
        <textarea name="content" rows="3" cols="40" placeholder="Write a message..."></textarea>
        <input type="submit" value="Send">
    </form>
  {% else %}
    <p><em>Please log in to post a message.</em></p>
  {% endif %}
  
  <h3>Messages</h3>
  <div class="messages">
    {% if messages %}
      {% for message in messages %}
        <p>
          <strong>{{ message.user.username }}:</strong>
          <span class="message-content">{{ message.content | nl2br | safe }}</span>
          <br><small>{{ message.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</small>
        </p>
      {% endfor %}
    {% else %}
      <p>No messages found.</p>
    {% endif %}
  </div>
{% endblock %}
